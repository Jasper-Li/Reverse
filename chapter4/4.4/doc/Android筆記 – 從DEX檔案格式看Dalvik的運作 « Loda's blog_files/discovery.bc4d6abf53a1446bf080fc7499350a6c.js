define("discovery/collections",["backbone","underscore","common/api","common/defines","discovery/helpers","discovery/models"],function(a,b,c,d,e,f){"use strict";var g=b.strip,h=a.Collection.extend({url:function(a){return c.getURL(a)},fetch:function(b){return b=b||{},b.reset=!0,a.Collection.prototype.fetch.call(this,b)},parse:function(a){return a.response}}),i=function(a){var b=a.prototype;return a.extend({url:function(){return b.url.call(this,"discovery/listTopPost.json")},parse:function(a){for(var c=b.parse.call(this,a),d=0,e=c.length;e>d;d++)c[d].plaintext=g(c[d].message);return c}})}(h),j=function(a){return a.extend({initialize:function(a,c){this.model=f[this.modelName],c&&b.has(c,"fetchLimit")&&(this.fetchLimit=c.fetchLimit)},fetch:function(b){return this.fetchLimit&&b.data&&(b.data[this.fetchLimitKey||"limit"]=this.fetchLimit),a.prototype.fetch.call(this,b)}})}(h),k=function(a){var b=a.prototype;return a.extend({modelName:"RelatedThread",url:function(){return b.url.call(this,"discovery/listRelated.json")}})}(j),l=function(a){return a=a||{},a.dataType="jsonp",a.omitDisqusApiKey=!0,a.data=a.data||{},delete a.data.thread,a},m=function(a){var c=a.prototype;return a.extend({modelName:"Advertisement",url:"//tempest.services.disqus.com/listPromoted",fetch:b.compose(function(a){return b.has(a.data,"limit")&&(a.data[this.fetchLimitKey]=a.data.limit,delete a.data.limit),c.fetch.call(this,a)},l),fetchLimitKey:"count",fetchThumbnailsKey:"thumbnails_only"})}(j),n=function(a){var c=a.prototype;return a.extend({initialize:function(a,b){c.initialize.apply(this,arguments),this.sessionStorage=b&&b.sessionStorage||window.sessionStorage},modelName:"TaboolaAdvertisement",url:function(a){return a=!d.debug&&a,"http://api.taboola.com/1.1/json/disqus"+(a?"-"+a:"")+"/recommendations.get"},getTaboolaSession:function(){var a;try{a=this.sessionStorage.getItem("taboolaSession")}catch(b){}return a||"init"},setTaboolaSession:function(a){try{this.sessionStorage.setItem("taboolaSession",a)}catch(b){e.log("Unable to store Taboola session in sessionStorage")}},fetch:b.compose(function(a){a.url=this.url(a.forum),b.extend(a.data,{"app.type":"desktop","app.apikey":"037849ccb5a799c70e319e9592c66e8b387105ff","source.type":"text","source.id":a.sourceThread.id,"source.url":a.sourceThreadUrl,"source.placement":a.placement,"user.session":this.getTaboolaSession()});var d=window.$&&window.$.fn&&window.$.fn.jquery&&window.$.fn.jquery.indexOf("1.9.2")>-1;return d?a.jsonp="rec.callback":a.jsonpCallback="rec.callback",b.has(a.data,"limit")&&(a.data[this.fetchLimitKey]=a.data.limit,delete a.data.limit),c.fetch.call(this,a)},l),fetchLimitKey:"rec.count",parse:function(a){this.setTaboolaSession(a.session);var c=79264;return b.map(a.list,function(a){return a.advertisement_id=c++,a})}})}(j),o={PostCollection:i,RelatedThreadCollection:k,AdvertisementCollection:m,TaboolaAdvertisementCollection:n};return DISQUS.testing&&(o.BaseCollection=h,o.BaseContentCollection=j),o}),define("discovery/helpers",["underscore","jquery","common/defines","common/logger"],function(a,b,c,d){"use strict";var e=!1,f=!1,g=function(a){e=!!a.lineTruncationEnabled,f=!!a.consoleLoggingEnabled},h=function(a){return b(a).closest("body").length&&!a.offsetTop},i=function(){return c.browser.mobile},j=function(){};window.console&&(j=function(){if(f){var b=a.toArray(arguments);b.unshift("[Discovery]"),window.console.log.apply?window.console.log.apply(window.console,b):window.console.log(b.join(" "))}});var k=function(b){return a.isUndefined(b)?f:(f=!!b,void 0)},l=function(b){return a.isUndefined(b)?e:(e=!!b,void 0)},m=function(c,f){function g(){return l.scrollHeight-l.offsetHeight>.2*m}function h(){k.lastChild&&!a.contains(["...","…"],k.lastChild.nodeValue)&&(n=k.appendChild(window.document.createTextNode(" "+p)),g()&&(k.removeChild(n),k.removeChild(k.lastChild),h()))}if(e){var i=d.logError||function(){};if(!c.closest("body").length)return void i("lineTruncate called on el not on DOM");if(c.text().length<1)return void i("lineTruncated called on empty el");var j=function(a){return 3!==a.nodeType};if(a.any(c.children(),j))return void i("lineTruncate called on non-flat el");var k=c[0],l=k;if("block"!==c.css("display"))for(;l.parentNode&&(l=l.parentNode,"block"!==b(l).css("display")););var m=parseFloat(c.css("font-size"),10);if(g()){f=f||{};var n,o=f.lines||1,p=f.ellipsis,q=c.text();if(q.length){var r=c.width()/m,s=parseInt(r*o,10),t=q.split(/\s/),u=0;c.empty();for(var v=0,w=t.length;w>v&&(u+=t[v].length+1,!(u>=s));v++)k.appendChild(document.createTextNode(" "+t[v]));if(g()){do n=k.removeChild(k.lastChild);while(g())}else{do n=k.appendChild(document.createTextNode(" "+t[v++]));while(!g()&&w>v);k.removeChild(n)}p&&(a.isString(p)||(p="…"),h())}}}},n=function(b){function c(a,b){return a+b}var d,e,f=a.keys(b),g=Math.floor(a.reduce(b,c,0)/2),h=f.length+1,i=g+1,j=new Array(h);for(d=0;h>d;d++)j[d]=new Array(i),j[d][0]={};for(e=1;i>e;e++)j[0][e]=!1;var k,l,m,n={};for(e=1;i>e;e++)for(d=1;h>d;d++)k=f[d-1],l=b[k],m=a.clone(j[d-1][e]),!m&&e>=l&&(m=a.clone(j[d-1][e-l]),m&&(m[k]=l,n=m)),j[d][e]=m;return[n,a.omit(b,a.keys(n))]};return{config:g,looksAdblocked:h,isMobile:i,log:j,allowLog:k,allowLineTruncate:l,lineTruncate:m,balancedPartition:n}}),define("discovery/models",["underscore","backbone","moment","common/analytics/identity","common/time","common/corefuncs"],function(a,b,c,d,e,f){"use strict";var g=function(a){var b=a.prototype;return a.extend({defaults:{redirectUrl:null,signedUrl:null,userId:null,sourceThreadId:null,forumId:null,forum:null,majorVersion:null,requestBin:null},redirectPayload:function(){var a={url:this.get("signedUrl"),imp:d.impression.impId,prev_imp:d.impression.prevImp,forum_id:this.get("forumId"),forum:this.get("forum"),thread_id:this.get("sourceThreadId"),major_version:this.get("majorVersion")};return this.has("requestBin")&&(a.bin=this.get("requestBin")),this.has("userId")&&(a.user_id=this.get("userId")),a},redirectUrl:function(){var a=this.get("redirectUrl"),b=this.redirectPayload();return f.serialize(a,b)},toJSON:function(){var a=b.toJSON.call(this);return a.redirectUrl=this.redirectUrl(),a},toString:function(){return this.get("title")+" "+this.get("link")+" (id = "+this.id+")"}})}(b.Model),h=function(b){var d=b.prototype;return b.extend({defaults:a.defaults({createdAgo:!1},d.defaults),initialize:function(a,b){if(b&&b.humanFriendlyTimestamp){var d=e.assureTzOffset(this.get("createdAt"));d=c(d,e.ISO_8601),this.set("createdAgo",d.fromNow())}},redirectPayload:function(){var b=d.redirectPayload.call(this);return a.extend(b,{thread:this.id,zone:"internal_discovery"}),b},toJSON:function(){var a=d.toJSON.call(this);return a.thumbnailUrl=a.thumbnail,a.preview&&(a.preview=a.preview.toJSON()),a},toString:function(){return"organic link: "+d.toString.call(this)}})}(g),i=function(b){var c=b.prototype;return b.extend({idAttribute:"advertisement_id",defaults:a.defaults({brand:null,headline:null,text:null,url:null,signedUrl:null,advertisement_id:null},c.defaults),parse:function(a){return a.signedUrl=a.signed_url,a.thumbnailUrl=a.thumbnail_url,delete a.signed_url,a},get:function(a){return{title:this.attributes.headline,link:this.attributes.url}[a]||c.get.call(this,a)},redirectPayload:function(){var b=c.redirectPayload.call(this);return a.extend(b,{zone:"promoted_discovery",advertisement_id:this.get("advertisement_id"),brand:this.get("brand"),headline:this.get("headline")}),b},toJSON:function(){var a=c.toJSON.call(this);return a.title=a.headline,a.link=a.url,a},toString:function(){return"promoted link: "+c.toString.call(this)}})}(g),j=function(b){return b.extend({idAttribute:"advertisement_id",apiMapping:{headline:"name",signedUrl:"url",brand:"branding"},parse:function(b){a.each(this.apiMapping,function(a,c){b[a]&&(b[c]=b[a],delete b[a])});var c=b.thumbnail;return b.thumbnailUrl=c&&c.length&&c[0]&&c[0].url,b}})}(i),k={RelatedThread:h,Advertisement:i,TaboolaAdvertisement:j};return DISQUS.testing&&(k.BaseContentModel=g),k}),define("discovery/variants",function(){"use strict";return{"default":{maxPerColumn:2,inlineMeta:!1,contentPreviews:!0,promotedEnabled:!1,topPlacementEnabled:!1},promoted:{maxPerColumn:4,inlineMeta:!0,contentPreviews:!1,promotedEnabled:!0,topPlacementEnabled:!1,promotedSide:"right"},max:{maxPerColumn:4,inlineMeta:!0,contentPreviews:!1,promotedEnabled:!0,topPlacementEnabled:!0,promotedSide:"left"},thumbnails:{maxOrganicThumbnailLinks:0,maxPromotedThumbnailLinks:3,promotedSide:"left",numLinesHeadline:4}}}),define("discovery/views",["backbone","underscore","jquery","common/templates","common/views/mixins","discovery/helpers"],function(a,b,c,d,e,f){"use strict";var g=a.View.extend({initialize:function(a){a&&a.appContext&&(this.appContext=a.appContext)},getTemplateContext:function(){return this.appContext?{variant:this.appContext}:{}},template:function(a,b){return b=b||this.templateName,d.render(b,a)}}),h=function(a){var d=a.prototype;return a.extend({events:{"click [data-redirect]":"handleClick"},handleClick:function(a){this.swapHref(a.currentTarget)},swapHref:function(a){a.setAttribute("data-href",a.getAttribute("href")),a.setAttribute("href",a.getAttribute("data-redirect")),b.delay(function(){a.setAttribute("href",a.getAttribute("data-href"))},100)},templateName:"discoveryCollection",initialize:function(a){d.initialize.call(this,a),this.elementsSelector="li.discovery-post",this.$elements=this.$el.find(this.elementsSelector),this.initContext=a.context;var b=this.collection;this.listenTo(b,{remove:this.remove,reset:this.render})},truncate:function(){var a=this.$el.find(".line-truncate");b.each(a,function(a){var b=c(a);f.lineTruncate(b,{lines:parseInt(b.attr("data-line-truncate"),10),ellipsis:!0})})},getTemplateContext:function(){var a=d.getTemplateContext.call(this);b.extend(a,this.initContext),a.collection=this.collection.toJSON();var c=this.collection.at(0);if(c){var e=c.has("id")?"organic-":"promoted-",f=c.idAttribute;b.each(a.collection,function(a){a.domIdSuffix=a[f],a.domIdSuffix=e+a.domIdSuffix})}return a},render:function(){var a=this.getTemplateContext();return this.$el.html(this.template(a)),this.$elements=this.$el.find(this.elementsSelector),this.truncate(),this},remove:function(a,d,e){if(0===arguments.length)return g.prototype.remove.call(this);var f=b.toArray(this.$elements),h=f.splice(e.index,1)[0];return c(h).remove(),this.$elements=c(f),this}})}(g),i=function(a,b){this.modelIds=a||[],this.$elements=c(b||[])};b.extend(i.prototype,{height:function(){var a=this;a.heights=[];var d=c(a.$elements),e=d.first().offset().top,f=function(){var a=d.last();return a.offset().top+a.height()}(),g=f-e,h=0;return b.each(d,function(b){var d=c(b).height();a.heights.push(d),h+=d}),this.interstice=(g-h)/(d.length-1),g}});var j=function(){this.divideIntoColumns=function(){var a=this,b=a.subviews[0];a.left=new i,a.right=new i;var c=0;b.collection.each(function(d,e){var f=c++%2===0?"left":"right";a[f].modelIds.push(d.id),Array.prototype.push.call(a[f].$elements,b.$elements[e])})},this.removeOneFromColumn=function(a,c){var d,e=b.chain(a.modelIds).map(function(b,c){return[b,a.heights[c]]}).sortBy(function(a){return-1*a[1]}).find(function(a){return a[1]<=c}).value()[0],f=this.subviews[0].collection,g=f.models,h=f.get(e),i=g.indexOf(h),j=[],k=[],l=[k,j],m=g.length;for(d=0;m>d;d++)l[d%2].push(g[d]);var n=l[i%2];n.splice(b.indexOf(n,h),1),g=[];var o=(i+1)%2;for(d=0;m-1>d;d++)g.push(l[(d+o)%2].shift());f.reset(g)},this.balanceColumns=function(){var a=this.subviews[0],c=a.collection,d={};c.each(function(b,c){d[c]=a.$elements[c]});var e=f.balancedPartition(d);e=b.sortBy(e,"length");var g=e[1],h=e[0],i=c.models,j=new Array(i.length);b.each(g,function(a,b){j[2*b]=i[b]}),b.each(h,function(a,b){j[2*b+1]=i[b]}),c.reset(i)},this.shortenColumn=function(a,b){var c=this.subviews[0].collection;c.length%2!==0&&a===this.left?this.removeOneFromColumn(a,this.fudge*b):this.balanceColumns()}},k=function(){this.divideIntoColumns=function(){var a=this,b=a.subviews,c=b[0],d=b[1],e=c.collection.model.prototype.idAttribute;a.left=new i(c.collection.pluck(e),c.$elements);var f=d.collection.model.prototype.idAttribute;a.right=new i(d.collection.pluck(f),d.$elements)},this.shortenColumn=function(a,c){for(var d=a===this.left?this.subviews[0]:this.subviews[1],e=a===this.left?this.right:this.left,f=e,g=c/f.$elements.length,h=d.collection,i=b.chain(a.modelIds).map(function(b,c){return[b,a.heights[c]]}).sortBy(function(a){return a[1]}).value(),j=[],k=0,l=c,m=g;i.length;){var n=i.pop(),o=n[0],p=n[1],q=p+a.interstice;if(k+q>c&&(f=a),l=Math.abs(c-(k+q)),m=l/f.$elements.length,!(m>=g)){g=m;var r=a.modelIds.indexOf(o);a.modelIds.splice(r,1),Array.prototype.splice.call(a.$elements,r,1),k+=q,j.push(o)}}h.remove(j)}},l=function(a){this.fudge=a.fudge,this.subviews=a.views.slice(0,2),1===this.subviews.length?j.call(this):k.call(this)};b.extend(l.prototype,{ascendingByHeight:function(){var a=this.left,c=this.right,d=[[a,a.height()],[c,c.height()]];return b.sortBy(d,function(a){return a[1]})},evenColumns:function(a){var c=this.ascendingByHeight(),d=c[0][0],e=c[0][1],f=c[1][0],g=c[1][1];if(e!==g){var h=g-e,i=this.fudge*h,j=b.find(f.heights,function(a){return a+f.interstice<i});return!a&&j?(this.shortenColumn(f,h),this.divideIntoColumns(),this.evenColumns("do not recurse again")):(this.increaseMargins(d,h),void 0)}},increaseMargins:function(a,d){var e=a.$elements.length;if(!(2>e)){var f=d/e;b.each(a.$elements,function(a){var b=c(a),d=parseInt(b.css("margin-bottom"),10),e=d+f;b.css("margin-bottom",e+"px")});var g=a===this.left?this.right:this.left,h=a===this.right?"left":"right";g.$elements.css("clear",h)}},render:function(){return this.divideIntoColumns(),this.evenColumns(),this}});var m=function(a){var c=a.prototype;return b.extend(c,e.IsVisibleViewMixin),a.extend({templateName:"discoveryMain",events:{"click [data-action=discovery-help]":function(a){a.preventDefault(),this.model.set("help",!0)},"click [data-action=discovery-help-close]":function(a){a.preventDefault(),this.model.set("help",!1)}},toggleHelp:function(a){var b=this;b.$el.find("#discovery-note").toggle(),a.trigger("resize")},rerenderHelp:function(){var a=this.$el.find("#discovery-note");a.length&&a.html(this.template(this.getTemplateContext(),"discoveryNote"))},initialize:function(a){c.initialize.call(this,a),this.listenTo(this.model,{"change:display":this.show,"change:help":this.toggleHelp}),this.listenTo(this.model.get("session"),"change",this.rerenderHelp),this.$el.css({position:"absolute",visibility:"hidden",display:"block",width:this.$el.width()-20+"px"}),this.topEdgeOffset=this.model.get("topEdgeOffset"),this.bottomEdgeOffset=this.model.get("bottomEdgeOffset")},createSections:function(){var a=this.model,c=a.get("sectionNames"),d=a.get("sectionIds");return b.map(a.collections,function(b,e){var f;return b===a.threads?f="organic":b===a.ads&&(f="promoted"),{id:d[e],className:c[e],type:f}})},getTemplateContext:function(){var a=this.model,b=this.createSections(),c=a.get("maxOrganicThumbnailLinks")||a.get("maxPromotedThumbnailLinks");return{id:a.get("innerContainerId"),sections:b,forum:a.get("sourceForum"),discoverySettingsUrl:a.get("promotedEnabled")&&a.get("discoverySettingsUrl"),session:a.get("session").toJSON(),thumbnailsEnabled:c}},render:function(){this.$el.html(this.template(this.getTemplateContext()))},show:function(a){a.get("display")&&(this.$el.css({position:"static",visibility:"visible",width:"100%"}),a.trigger("resize"))},remove:function(a){var b;return a&&a.cloneContainer&&(b=this.el.cloneNode(!1),this.$el.attr("id",""),this.$el.after(b)),c.remove.call(this)},calculateOffsetTop:function(){var a=this.$el.offset();return a.top}})}(g);return{BaseCollectionView:h,TwoColumn:l,MainView:m}}),this.Handlebars=this.Handlebars||{},this.Handlebars.discovery=this.Handlebars.discovery||{},this.Handlebars.discovery.templates=Handlebars.template(function(a,b,c,d,e){function f(a,b){var d,e="";return e+="\n"+"\n",d=c["if"].call(a,a.sessionUserId,{hash:{},inverse:T.noop,fn:T.program(2,g,b),data:b}),(d||0===d)&&(e+=d),e+="\n"}function g(a,b){var d,e,f="";return f+='\n<div class="follow-btn-wrap">\n',e=c["if"].call(a,(d=a.user,null==d||d===!1?d:d.isSession),{hash:{},inverse:T.program(6,j,b),fn:T.program(3,h,b),data:b}),(e||0===e)&&(f+=e),f+="\n</div>\n"}function h(a,b){var d,e,f="";return f+="\n",e=c["if"].call(a,(d=a.user,null==d||d===!1?d:d.isEditable),{hash:{},inverse:T.noop,fn:T.program(4,i,b),data:b}),(e||0===e)&&(f+=e),f+="\n\n"+"\n"}function i(a,b){var d="";return d+='\n<a href="#" data-action="edit-profile" target="_blank" class="btn follow-btn edit-profile">'+S(c.t.call(a,gettext("Edit profile"),{hash:{},data:b}))+"</a>\n"}function j(a,b){var d,e,f="";return f+="\n",e=c["if"].call(a,(d=a.user,null==d||d===!1?d:d.isPrivate),{hash:{},inverse:T.program(9,l,b),fn:T.program(7,k,b),data:b}),(e||0===e)&&(f+=e),f+="\n"}function k(a,b){var d="";return d+='\n<span class="btn follow-btn private">\n<i aria-hidden="true" class="icon-lock"></i>\n<span class="btn-text">'+S(c.t.call(a,gettext("Private"),{hash:{},data:b}))+"</span>\n</span>\n"}function l(a,b){var d,e,f="";return f+='\n<a href="'+S((d=a.user,d=null==d||d===!1?d:d.profileUrl,typeof d===U?d.apply(a):d))+'" class="btn follow-btn ',e=c["if"].call(a,(d=a.user,null==d||d===!1?d:d.isFollowing),{hash:{},inverse:T.noop,fn:T.program(10,m,b),data:b}),(e||0===e)&&(f+=e),f+='" data-action="follow-user" data-user="'+S((d=a.user,d=null==d||d===!1?d:d.id,typeof d===U?d.apply(a):d))+'">\n<span class="btn-text following-text">'+S(c.t.call(a,gettext("Following"),{hash:{},data:b}))+'</span>\n<span class="btn-text follow-text">'+S(c.t.call(a,gettext("Follow"),{hash:{},data:b}))+'</span>\n<i aria-hidden="true" class="icon-plus"></i> '+'\n<i aria-hidden="true" class="icon-checkmark"></i>\n</a>\n'}function m(){return"following"}function n(a,b){var d,e="";return e+="\n",d=c.each.call(a,a.collection,{hash:{},inverse:T.noop,fn:T.programWithDepth(o,b,a),data:b}),(d||0===d)&&(e+=d),e+="\n"}function o(a,b,e){var f,g,h="";return h+='\n<li class="discovery-post',f=c["if"].call(a,e.thumbnailsEnabled,{hash:{},inverse:T.noop,fn:T.program(14,p,b),data:b}),(f||0===f)&&(h+=f),h+='" id="discovery-link-'+S((f=a.domIdSuffix,typeof f===U?f.apply(a):f))+'">\n<a ',g=T.invokePartial(d.linkAttributes,"linkAttributes",a,c,d,b),(g||0===g)&&(h+=g),h+=' class="publisher-anchor-color">\n',g=c["if"].call(a,e.thumbnailsEnabled,{hash:{},inverse:T.noop,fn:T.program(16,q,b),data:b}),(g||0===g)&&(h+=g),h+='\n\n<header class="discovery-post-header">\n<h3 title="'+S((f=a.title,typeof f===U?f.apply(a):f))+'">\n<span data-role="discovery-thread-title" class="title line-truncate" data-line-truncate="'+S((f=e.variant,f=null==f||f===!1?f:f.numLinesHeadline,typeof f===U?f.apply(a):f))+'">\n'+S(c.html.call(a,a.title,{hash:{},data:b}))+"\n</span>\n\n"+"\n"+"\n",g=c["if"].call(a,(f=e.variant,null==f||f===!1?f:f.inlineMeta),{hash:{},inverse:T.noop,fn:T.program(18,r,b),data:b}),(g||0===g)&&(h+=g),h+="\n\n</h3>\n\n",g=c.unless.call(a,(f=e.variant,null==f||f===!1?f:f.inlineMeta),{hash:{},inverse:T.noop,fn:T.program(26,w,b),data:b}),(g||0===g)&&(h+=g),h+="\n</header>\n\n",g=c["if"].call(a,(f=e.variant,(null==f||f===!1?f:f.contentPreviews)&&a.preview),{hash:{},inverse:T.noop,fn:T.program(31,z,b),data:b}),(g||0===g)&&(h+=g),h+="\n</a>\n</li>\n"}function p(){return" hasthumbnail"}function q(a){var b,c="";return c+='\n<div class="thumbnail"\nstyle="background-image: url('+S((b=a.thumbnailUrl,typeof b===U?b.apply(a):b))+');">\n</div>\n'}function r(a,b){var d,e="";return e+="\n",d=c["if"].call(a,a.posts>0,{hash:{},inverse:T.program(21,t,b),fn:T.program(19,s,b),data:b}),(d||0===d)&&(e+=d),e+="\n",d=c["if"].call(a,a.brand,{hash:{},inverse:T.noop,fn:T.program(24,v,b),data:b}),(d||0===d)&&(e+=d),e+="\n"}function s(a,b){var e,f="";return f+='\n<span class="inline-meta">\n',e=T.invokePartial(d.discoveryPostCount,"discoveryPostCount",a,c,d,b),(e||0===e)&&(f+=e),f+="\n</span>\n"}function t(a,b){var d,e="";return e+="\n",d=c["if"].call(a,a.createdAgo,{hash:{},inverse:T.noop,fn:T.program(22,u,b),data:b}),(d||0===d)&&(e+=d),e+="\n"}function u(a){var b,c="";return c+='\n<span class="inline-meta">'+S((b=a.createdAgo,typeof b===U?b.apply(a):b))+"</span>\n"}function v(a){var b,c="";return c+='\n<span class="inline-meta">\n'+S((b=a.brand,typeof b===U?b.apply(a):b))+"\n</span>\n"}function w(a,b){var d,e="";return e+='\n<ul class="meta">\n',d=c["if"].call(a,a.posts>0,{hash:{},inverse:T.noop,fn:T.program(27,x,b),data:b}),(d||0===d)&&(e+=d),e+="\n",d=c["if"].call(a,a.createdAgo,{hash:{},inverse:T.noop,fn:T.program(29,y,b),data:b}),(d||0===d)&&(e+=d),e+="\n</ul>\n"}function x(a,b){var e,f="";return f+='\n<li class="comments">\n',e=T.invokePartial(d.discoveryPostCount,"discoveryPostCount",a,c,d,b),(e||0===e)&&(f+=e),f+="\n</li>\n"}function y(a){var b,c="";return c+='\n<li class="time">'+S((b=a.createdAgo,typeof b===U?b.apply(a):b))+"</li>\n"}function z(a,b){var e,f="";return f+="\n",e=T.invokePartial(d.discoveryContentPreview,"discoveryContentPreview",a,c,d,b),(e||0===e)&&(f+=e),f+="\n"}function A(a,b){var d,e,f="";return f+='\nhref="'+S((d=a.redirectUrl,typeof d===U?d.apply(a):d))+'" ',e=c["if"].call(a,a.brand,{hash:{},inverse:T.noop,fn:T.program(34,B,b),data:b}),(e||0===e)&&(f+=e),f+="\n"}function B(){return'target="_blank" rel="nofollow norewrite"'}function C(a,b){var e,f="";return f+="\n<a ",e=T.invokePartial(d.linkAttributes,"linkAttributes",a,c,d,b),(e||0===e)&&(f+=e),f+=' class="top-comment" data-role="discovery-top-comment">\n<img data-src="'+S((e=a.preview,e=null==e||e===!1?e:e.author,e=null==e||e===!1?e:e.avatar,e=null==e||e===!1?e:e.cache,typeof e===U?e.apply(a):e))+'" alt="'+S(c.t.call(a,gettext("Avatar"),{hash:{},data:b}))+'" data-role="discovery-avatar">\n<p><span class="user" data-role="discovery-top-comment-author">'+S((e=a.preview,e=null==e||e===!1?e:e.author,e=null==e||e===!1?e:e.name,typeof e===U?e.apply(a):e))+'</span> &#8212; <span data-role="discovery-top-comment-snippet" class="line-truncate" data-line-truncate="3">'+S((e=a.preview,e=null==e||e===!1?e:e.plaintext,typeof e===U?e.apply(a):e))+"</span></p>\n</a>\n"}function D(a,b){var d,e="";return e+="\n",d=c["if"].call(a,1===a.posts,{hash:{},inverse:T.program(41,F,b),fn:T.program(39,E,b),data:b}),(d||0===d)&&(e+=d),e+="\n"}function E(a,b){var d="";return d+="\n"+S(c.t.call(a,gettext("1 comment"),{hash:{},data:b}))+"\n"}function F(a,b){var d="";return d+="\n"+S(c.t.call(a,gettext("%(numPosts)s comments"),{hash:{numPosts:a.posts},data:b}))+"\n"}function G(a,b){var e,f,g="";return g+='\n<div id="'+S((e=a.id,typeof e===U?e.apply(a):e))+'" class="discovery-main',f=c["if"].call(a,a.thumbnailsEnabled,{hash:{},inverse:T.noop,fn:T.program(44,H,b),data:b}),(f||0===f)&&(g+=f),g+='">\n<div id="discovery-note" class="discovery-note">\n',f=T.invokePartial(d.discoveryNote,"discoveryNote",a,c,d,b),(f||0===f)&&(g+=f),g+='\n</div>\n\n<div class="discovery-options">\n<button class="discovery-help" data-action="discovery-help">\n'+S(c.t.call(a,gettext("What's this?"),{hash:{},data:b}))+"\n</button>\n</div>\n\n",f=c.each.call(a,a.sections,{hash:{},inverse:T.noop,fn:T.programWithDepth(I,b,a),data:b}),(f||0===f)&&(g+=f),g+="\n\n</div>\n"}function H(){return" discovery-thumbnails"}function I(a,b,d){var e,f,g="";return g+="\n"+'\n<section id="'+S((e=a.id,typeof e===U?e.apply(a):e))+'" class="'+S((e=a.className,typeof e===U?e.apply(a):e))+" discovery-col-"+S((e=b.index,typeof e===U?e.apply(a):e))+'" >\n<header class="discovery-col-header">\n\n',f=c["if"].call(a,"organic"===a.type,{hash:{},inverse:T.noop,fn:T.programWithDepth(J,b,d),data:b}),(f||0===f)&&(g+=f),g+="\n\n",f=c["if"].call(a,"promoted"===a.type,{hash:{},inverse:T.noop,fn:T.program(49,K,b),data:b}),(f||0===f)&&(g+=f),g+='\n\n</header>\n<ul class="discovery-posts">\n</ul>\n</section>\n'}function J(a,b,d){var e="";return e+="\n<h2>"+S(c.t.call(a,gettext("Also on %(forumName)s"),{hash:{forumName:{partial:"forumName",context:d.forum,executePartial:!0}},data:b}))+"</h2>\n"}function K(a,b){var d="";return d+="\n<h2>"+S(c.t.call(a,gettext("Around The Web"),{hash:{},data:b}))+"</h2>\n"}function L(a,b){var d="";return d+='\n<a href="http://help.disqus.com/customer/portal/articles/666278-introducing-promoted-discovery-and-f-a-q-"\ntarget="_blank">'+S(c.t.call(a,gettext("Learn more"),{hash:{},data:b}))+"</a>\n"}function M(a,b){var d="";return d+='\n<a href="https://www.surveymonkey.com/s/GHK872T" target="_blank">\n'+S(c.t.call(a,gettext("give us feedback"),{hash:{},data:b}))+"</a>"}function N(a){var b,c="";return c+="\n<strong>"+S((b=a.name,typeof b===U?b.apply(a):b))+"</strong>\n"}function O(a,b,d){var e,f,g="";return g+='\n<div class="alert">\n<button class="close" data-action="discovery-help-close" title="'+S(c.t.call(a,gettext("Close this box"),{hash:{},data:b}))+'">×</button>\n'+S(c.t.call(a,gettext("Disqus helps you find new and interesting content, discussions and products. Some sponsors and ecommerce sites may pay us for these recommendations and links. %(learnMore)s or %(feedback)s."),{hash:{learnMore:{partial:"learnMore",context:d,executePartial:!0},feedback:{partial:"feedback",context:d,executePartial:!0}},data:b}))+"\n",f=c["if"].call(a,(e=a.session,e=null==e||e===!1?e:e.thread,(null==e||e===!1?e:e.canModerate)&&a.discoverySettingsUrl),{hash:{},inverse:T.noop,fn:T.program(58,P,b),data:b}),(f||0===f)&&(g+=f),g+="\n</div>\n"}function P(a,b){var d,e="";return e+='\n<br/>\n<a href="'+S((d=a.discoverySettingsUrl,typeof d===U?d.apply(a):d))+'" target="_blank" class="btn">'+S(c.t.call(a,gettext("Change %(Discovery)s settings for %(forumName)s"),{hash:{Discovery:"Discovery",forumName:(d=a.forum,null==d||d===!1?d:d.name)},data:b}))+"</a>\n"}this.compilerInfo=[2,">= 1.0.0-rc.3"],c=c||a.helpers,d=d||a.partials,e=e||{};var Q,R="",S=this.escapeExpression,T=this,U="function";return Q=c.partial.call(b,"followButton",{hash:{},inverse:T.noop,fn:T.program(1,f,e),data:e}),(Q||0===Q)&&(R+=Q),R+="\n\n",Q=c.partial.call(b,"discoveryCollection",{hash:{},inverse:T.noop,fn:T.program(12,n,e),data:e}),(Q||0===Q)&&(R+=Q),R+="\n\n",Q=c.partial.call(b,"linkAttributes",{hash:{},inverse:T.noop,fn:T.program(33,A,e),data:e}),(Q||0===Q)&&(R+=Q),R+="\n\n",Q=c.partial.call(b,"discoveryContentPreview",{hash:{},inverse:T.noop,fn:T.program(36,C,e),data:e}),(Q||0===Q)&&(R+=Q),R+="\n\n",Q=c.partial.call(b,"discoveryPostCount",{hash:{},inverse:T.noop,fn:T.program(38,D,e),data:e}),(Q||0===Q)&&(R+=Q),R+="\n\n",Q=c.partial.call(b,"discoveryMain",{hash:{},inverse:T.noop,fn:T.program(43,G,e),data:e}),(Q||0===Q)&&(R+=Q),R+="\n\n",Q=c.partial.call(b,"learnMore",{hash:{},inverse:T.noop,fn:T.program(51,L,e),data:e}),(Q||0===Q)&&(R+=Q),R+="\n\n",Q=c.partial.call(b,"feedback",{hash:{},inverse:T.noop,fn:T.program(53,M,e),data:e}),(Q||0===Q)&&(R+=Q),R+="\n"+"\n\n",Q=c.partial.call(b,"forumName",{hash:{},inverse:T.noop,fn:T.program(55,N,e),data:e}),(Q||0===Q)&&(R+=Q),R+="\n\n\n",Q=c.partial.call(b,"discoveryNote",{hash:{},inverse:T.noop,fn:T.programWithDepth(O,e,b),data:e}),(Q||0===Q)&&(R+=Q),R+="\n"}),define("discovery",["backbone","underscore","jquery","when","common/bus","common/defines","common/juggler","discovery/collections","discovery/helpers","discovery/variants","discovery/views"],function(a,b,c,d,e,f,g,h,i,j,k){"use strict";function l(a){var c=b.object(b.map(["lineTruncationEnabled","consoleLoggingEnabled"],function(b){return b in a?[b,a[b]]:[b,m.prototype.defaults[b]]}));return i.config(c),new m(a)}var m=a.Model.extend({defaults:{name:"promoted",inlineMeta:!0,contentPreviews:!1,promotedEnabled:!0,topPlacementEnabled:!1,redirectUrl:"http://redirect.disqus.com/url",listRelatedLimit:null,listPromotedLimit:null,httpTimeout:1e4,sourceThread:null,sourceForum:null,sourceThreadUrl:null,useTaboolaAdserver:!1,organicExperimentsEnabled:!1,discoverySettingsUrl:null,help:!1,display:!1,columnEveningEnabled:!0,numColumns:2,minPerColumn:1,maxPerColumn:null,toleranceCoefficient:1.2,maxOrganicTextLinks:null,maxPromotedTextLinks:null,maxOrganicThumbnailLinks:null,maxPromotedThumbnailLinks:null,minWidthForColumnLayout:440,containerId:"discovery",topPlacementContainerId:"discovery-top",innerContainerName:"discovery-main",sectionNames:["col-organic","col-promoted"],collectionTagName:"ul",collectionClassName:"discovery-posts",promotedSide:"right",organicThumbnailClass:"discovery-thumbnails",promotedThumbnailClass:"doublethumbnails",consoleLoggingEnabled:f.debug,lineTruncationEnabled:!0,session:null,numLinesHeadline:2,thumbnailMinHeight:200,thumbnailMinWidth:200,thumbnailAspectRatioMin:.5,thumbnailAspectRatioMax:1.8,shouldEvenThumbnails:!1,thumbnailTimeout:2e3,minThumbnailsNeeded:null,js:null,css:null,seenByUserThresholdTime:2e3,inViewport:!1,trackAdVisibility:null,position:null,topEdgeOffset:0,bottomEdgeOffset:1/0},get:function(b){if(b in m.loggedinOverrides){var c=this.get("session");if(c&&!c.isAnonymous())return m.loggedinOverrides[b]}return a.Model.prototype.get.apply(this,arguments)},initialize:function(a){var c=this;this.collections=[],c.configure(a),c.once("change:display",function(){c.onComplete()}),b.bindAll(c,"getContentPreviews","validateData","showData","updatePosition","reportIfVisible"),c.run(),this.get("trackAdVisibility")&&c.trackVisibility()},trackVisibility:function(){this.debouncedReportIfVisible=b.debounce(this.reportIfVisible,this.get("seenByUserThresholdTime")),this.debouncedUpdatePosition=b.debounce(this.updatePosition,200),this.listenTo(e,{"window.scroll window.resize":this.debouncedUpdatePosition}),this.listenTo(this,"change:inViewport",this.scheduleVisibilityReport),this.listenTo(this,"change:position",this.updateVisibility)},configure:function(a){a=a||{};var c=this,d=j[c.get("name")]||{};if(c.get("thumbnailsEnabled")&&b.extend(d,j.thumbnails),c.set(b.defaults(a,d)),c.has("maxPerColumn")){var e=c.get("promotedEnabled")?1:2;c.set("maxOrganicTextLinks",e*c.get("maxPerColumn")),c.set("maxPromotedTextLinks",c.get("maxPerColumn"))}else c.has("maxOrganicTextLinks")&&c.set("maxPerColumn",c.get("maxOrganicTextLinks"));c.set("innerContainerId",c.get("innerContainerName")+"-"+c.cid),c.set("sectionIds",b.map(c.get("sectionNames"),function(a){return a+"-"+c.cid})),c.get("topPlacementEnabled")&&c.set("containerId",c.get("topPlacementContainerId"))},numSections:function(){return this.collections.length||(this.get("promotedEnabled")?2:1)},commonClickMetadata:function(){var a=this.get("sourceThread"),b=this.get("sourceForum"),c={redirectUrl:this.get("redirectUrl"),sourceThreadId:a.id,forumId:b.pk,forum:b.id,majorVersion:this.majorVersion(),requestBin:this.get("requestBin")},d=this.get("session");return d&&d.isRegistered()&&(c.userId=d.user.id),c},augmentModels:function(a){a.invoke("set",this.commonClickMetadata())},augmentCollection:function(a,b){var c=this;a.meta={max:function(){return c.get("max"+b+"ThumbnailLinks")||c.get("max"+b+"TextLinks")},min:function(){return c.get("minThumbnailsNeeded")||c.get("numColumns")/c.numSections()*c.get("minPerColumn")},name:b}},run:function(){var a=b.bind(this.onComplete,this);this.getData().then(this.validateData).then(this.showData).otherwise(a)},getIntendedPlacement:function(){var a="";return this.threads&&(a+=this.threads.meta.max()+" unpaid ",a+=this.get("maxOrganicThumbnailLinks")?"thumbnail":"text",a+=" links "),this.ads&&this.get("promotedEnabled")&&(a+=a&&"and ",a+=this.ads.meta.max()+" paid ",a+=this.get("maxPromotedThumbnailLinks")?"thumbnail":"text",a+=" links "),a+=this.get("topPlacementEnabled")?"above":"below",a+=" embed"},generateFetchOptions:function(a,b){var c={timeout:this.get("httpTimeout"),data:{thread:this.get("sourceThread").id,limit:2*a.meta.max()},sourceThread:this.get("sourceThread")};return b&&(c.data.limit=4,c.sourceThreadUrl=this.get("sourceThreadUrl"),c.forum=this.get("sourceForum").id,c.placement=this.getIntendedPlacement()),c},getDataOrganic:function(){var a=this;a.threads=new h.RelatedThreadCollection(null,{fetchLimit:this.get("listRelatedLimit")}),a.augmentCollection(a.threads,"Organic");var b=this.generateFetchOptions(a.threads);
b.humanFriendlyTimestamp=!0;var c=d(a.threads.fetch(b));if(a.get("contentPreviews")&&(c=c.then(function(){return a.getContentPreviews().otherwise(function(a){i.log("There was a problem getting snippets: ",a)})})),a.get("organicExperimentsEnabled")){var e=a.getOrganicExperiment().then(function(b){b&&a.organicExperimentHandlers[b]&&a.organicExperimentHandlers[b].call(a)});return d.join(c,e)}return c},activateThumbnails:function(){var a=this;i.log("Organic thumbnails must meet the following requirements:"),i.log("Minimum width",a.get("thumbnailMinWidth"),"px"),i.log("Minimum height",a.get("thumbnailMinHeight"),"px"),i.log("Minimum aspect ratio",a.get("thumbnailAspectRatioMin"),"px"),i.log("Maximum aspect ratio",a.get("thumbnailAspectRatioMax"),"px"),a.set({columnEveningEnabled:!1,contentPreviews:!1})},deactivateThumbnails:function(){this.set({columnEveningEnabled:!0,contentPreviews:!0})},organicExperimentHandlers:{"embed:organic_discovery:tempest:thumbnails:active":function(){this.activateThumbnails(),this.set("minThumbnailsNeeded",2),this.set("maxOrganicTextLinks",4),this.set("maxOrganicThumbnailLinks",4),this.set("shouldEvenThumbnails",!0)}},getOrganicExperiment:function(){var a=this,b=d.defer();return a.get("promotedEnabled")?b.resolve(null):(c.ajax({url:h.AdvertisementCollection.prototype.url,data:{count:0},dataType:"jsonp",success:function(c){var d;c&&c.bin&&(d=c.bin,a.set("requestBin",d)),b.resolve(d)},error:function(){b.resolve(null)}}),b.promise)},getDataPromoted:function(){var a=this,b=a.get("useTaboolaAdserver")?h.TaboolaAdvertisementCollection:h.AdvertisementCollection;a.ads=new b(null,{fetchLimit:a.get("listPromotedLimit")}),a.augmentCollection(a.ads,"Promoted");var c=a.generateFetchOptions(a.ads,a.get("useTaboolaAdserver"));a.ads.fetchThumbnailsKey&&a.get("maxPromotedThumbnailLinks")>0&&(c.data[a.ads.fetchThumbnailsKey]=1);var e=d(a.ads.fetch(c)),f=e.then(function(b){var c=b.bin;return c?a.has("requestBin")?e:(a.set("requestBin",c),a.handleExperiment(c)):e});return f},getData:function(){var a=this.getDataOrganic();if(this.get("promotedEnabled")){var c=this.getDataPromoted();a=a.always(function(){return c})}return a.always(b.bind(this.sequenceDataCollections,this))},sequenceDataCollections:function(){this.collections=b.compact([this.threads,this.ads]),"left"===this.get("promotedSide")&&this.collections.reverse()},handleExperiment:function(a){return this.experimentHandlers[a]?this.experimentHandlers[a].call(this):void 0},experimentHandlers:{"embed:promoted_discovery:tempest:taboola:active":function(){return this.set("experimentVariant","taboola"),this.set("useTaboolaAdserver",!0),this.getDataPromoted()},"embed:promoted_discovery:tempest:taboola:thumbnails":function(a){return this.activateThumbnails(),this.set(b.extend({maxOrganicThumbnailLinks:3,maxPromotedThumbnailLinks:3,useTaboolaAdserver:!0,promotedSide:"left",numLinesHeadline:3},a)),this.getDataPromoted()},"embed:promoted_discovery:tempest:taboola:hybridthumbnails":function(){var a="embed:promoted_discovery:tempest:taboola:thumbnails";return this.experimentHandlers[a].call(this,{maxOrganicThumbnailLinks:0})},"embed:promoted_discovery:tempest:taboola:ourpdthumbnails":function(){this.activateThumbnails(),this.set({maxOrganicThumbnailLinks:0,maxPromotedThumbnailLinks:3,useTaboolaAdserver:!1,promotedSide:"left",numLinesHeadline:3})},"embed:promoted_discovery:tempest:thumbnails:control":function(){this.set({maxPromotedThumbnailLinks:!1,promotedSide:"max"===this.get("name")?"left":"right",numLinesHeadline:2})},"embed:promoted_discovery:tempest:thumbnails:quarantine":function(){return this.experimentHandlers["embed:promoted_discovery:tempest:thumbnails:control"].call(this)}},getContentPreviews:function(){var a=this.threads.map(function(a){return parseInt(a.get("id"),10)});if(a.length<this.threads.meta.min())return d.resolve();a.sort(function(a,b){return a-b}),this.previews=new h.PostCollection;var c=d(this.previews.fetch({data:{thread:a},timeout:this.get("httpTimeout")}));return c.then(b.bind(this.attachPreviews,this))},attachPreviews:function(){var a=this;a.previews.each(function(b){var c=b.get("thread"),d=a.threads.get(c);d&&d.set("preview",b)})},validateCollectionMin:function(){for(var a,b,c=this.collections,d=c.length;d>0;)a=c[--d],b=a.meta.min(),a.length<b&&(c.splice(d,1),d=c.length)},trimCollections:function(){for(var a,b,c=this.collections,d=c.length,e=0;d>e;e++)a=c[e],b=a.meta.max(),a.length>b&&a.reset(a.slice(0,b));this.get("shouldEvenThumbnails")&&this.threads.length%2!==0&&(i.log("Number of related threads ("+this.threads.length+") is odd.","Removing one to make even."),this.threads.pop())},isThumbnailOk:function(a){var b=this,c=a.width,d=a.height,e=c/d;return c>=b.get("thumbnailMinWidth")&&d>=b.get("thumbnailMinHeight")&&e>=b.get("thumbnailAspectRatioMin")&&e<=b.get("thumbnailAspectRatioMax")},areThumbnailsGood:function(a,e){var f=this;return a.map(function(a){var g,h=new Image,j=d.defer();return c(h).on("load",function(){f.isThumbnailOk(this)?(e.push(a),j.resolve(a.id)):(i.log("Image is not good. Width",this.width,"Height",this.height,"Aspect Ratio",this.width/this.height,"Src",this.src),j.reject("Image is not good")),clearTimeout(g)}).on("error",function(){i.log("Image could not be loaded. Src",this.src),j.reject("Error loading image"),clearTimeout(g)}),h.src=a.get("thumbnail"),g=b.delay(function(){i.log("Image is taking too long to load. Src",h.src),j.reject("Image taking too long")},f.get("thumbnailTimeout")),j.promise})},validateThumbnails:function(a){function c(){return i.log("Verified minimum number of thumbnails needed: "+g),d.some(k,h).then(function(c){var d=a.pluck("id"),e=b.difference(d,c);i.log("Maximum number ("+h+") of thumbnails verified.","Removing excess models.",e),a.reset(j)},function(){i.log("Cannot reach thumbnail max. "+"Carrying on with the amount obtained: "+j.length),a.reset(j)})}function e(){i.log("Cannot get enough good thumbnails. "+"Falling back to normal design."),f.set("maxOrganicThumbnailLinks",0),1===f.collections.length&&f.deactivateThumbnails()}if(a.length){var f=this,g=a.meta.min(),h=a.meta.max(),j=[],k=f.areThumbnailsGood(a,j);return k.length<g?d.resolve(e()):d.some(k,g).then(c,e)}},validateData:function(){if(i.isMobile()&&this.ads&&this.ads.length>0&&this.ads.remove(this.ads.where({mobile:!1})),this.validateCollectionMin(),0===this.collections.length)throw new Error("Not enough data");return b.each(this.collections,this.augmentModels,this),this.threads&&this.get("maxOrganicThumbnailLinks")?this.validateThumbnails(this.threads):void 0},renderViews:function(){function a(a){b.extend(this,a),this.appContext=d.toJSON()}var d=this,e=document.getElementById(d.get("containerId"));if(!e)throw new Error("No container on the DOM");var f=d.mainView=new k.MainView(new a({el:e,model:d}));f.render();var g=d.get("sectionIds"),h=d.get("collectionTagName"),i=d.get("collectionClassName");d.views=b.map(d.collections,function(b,e){var f=new k.BaseCollectionView(new a({collection:b,el:c("#"+g[e]+" "+h+"."+i),context:{thumbnailsEnabled:!!d.get("max"+b.meta.name+"ThumbnailLinks")}}));return b.meta.view=f,f}),d.get("maxPromotedThumbnailLinks")?f.$el.find("#"+d.get("innerContainerId")).addClass("doublethumbnails"):2===d.views.length&&f.$el.find("#"+d.get("innerContainerId")).addClass("doublesection"),b.invoke(d.views,"render"),d.updateVisibility()},areThumbnailsViable:function(){return b.any(this.collections,function(a){return this.get("max"+a.meta.name+"ThumbnailLinks")},this)},evenColumns:function(){var a=this;if(!a.areThumbnailsViable())if(a.get("columnEveningEnabled")&&a.mainView.$el.width()>a.get("minWidthForColumnLayout")){var c=new k.TwoColumn({views:a.views,fudge:this.get("toleranceCoefficient")});c.render()}else{var d=b.min(b.pluck(a.collections,"length"));b.each(a.views,function(a){for(;a.collection.length>d;)a.collection.pop()})}},showData:function(){var a=this;a.trimCollections(),a.renderViews(),a.manageAdblock(),a.evenColumns(),a.set("display",!0)},manageAdblock:function(){var a=this.ads&&this.ads.meta.view;if(a&&i.looksAdblocked(a.el)){if(!(this.views.length>1))throw new Error("No organic results and promoted results appear to be blocked");this.mainView.remove({cloneContainer:!0}),this.ads.reset(null,{silent:!0}),this.validateCollections(),this.renderViews()}},onComplete:function(a){var b=i.log;return this.onCompleteCalled?b("Error: Final reporting function called more than once"):(this.onCompleteCalled=!0,a&&b("It looks like there was a problem:",a),this.report("init_discovery",this.snapshot()),void 0)},report:function(a,b){var c=i.log,d=g.client("juggler");return d?(c("Sending analytics data about this Discovery impression:"),c(a+":",b),"discovery_visible"!==a&&d.emit(a,b),this.get("darkJester")&&g.client("jester",!0).emit(a,b),void 0):void c("Cannot report app state, no client found")},updatePosition:function(a){this.set("position",a)},updateVisibility:function(){var a=this.mainView&&this.get("position");a&&this.set("inViewport",this.isInViewport())},isInViewport:function(){return this.mainView.invalidateOffset(),this.mainView.isVisible(this.get("position"))},reportIfVisible:function(){this.get("inViewport")&&(this.report("discovery_visible",this.getAdsInfo()),this.stopListening(e,"window.scroll window.resize"))},scheduleVisibilityReport:function(){this.get("inViewport")&&this.debouncedReportIfVisible()},majorVersion:function(){return this.get("promotedEnabled")?"midway":"metadata"},snapshot:function(){var a=this.threads,c={major_version:this.majorVersion(),internal_organic:a.length,external_organic:0,promoted:0,display:this.get("display"),placement:this.get("containerId")===this.get("topPlacementContainerId")?"top":"bottom"};return this.has("requestBin")&&(c.bin=this.get("requestBin")),b.extend(c,this.getAdsInfo()),c},getAdsInfo:function(){var a={};return this.get("promotedEnabled")&&b.extend(a,{promoted:this.ads.length,promoted_ids:JSON.stringify(this.ads.pluck("advertisement_id"))}),a}},{loggedinOverrides:{topPlacementEnabled:!1,promotedSide:"right"}}),n={};return DISQUS.testing&&(n.DiscoveryApp=m),n.init=l,n});